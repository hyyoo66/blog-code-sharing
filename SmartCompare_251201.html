<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCompare - íŒŒì¼ ë¹„êµ ë„êµ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #2d2d30;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #2d2d30;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        
        /* ì¶”ê°€ëœ ë¬¸ìì—´ ìŠ¤íƒ€ì¼ */
        .subtitle {
            font-size: 12px;
            color: #ccc;
            margin-left: 10px;
            font-weight: normal;
        }


        .controls {
            display: flex;
            gap: 10px;
        }
        
        /* ìˆ˜ì •ëœ ì»¨íŠ¸ë¡¤ ê·¸ë£¹: íŒŒì¼ ì¡°ì‘ ë²„íŠ¼ì„ ì—¬ê¸°ì— ë°°ì¹˜ */
        .file-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px; /* ìš°ì¸¡ ë²„íŠ¼ê³¼ì˜ ê°„ê²© í™•ë³´ */
        }
        
        /* â˜… [ì¶”ê°€] ìë™ ì €ì¥ ì£¼ê¸° ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .auto-save-control {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ccc;
            font-size: 12px;
            margin-left: 15px;
        }

        .auto-save-control input[type="range"] {
            width: 100px;
            margin: 0 5px;
        }

        .auto-save-control input[type="number"] {
            width: 40px;
            padding: 2px 5px;
            border: 1px solid #3e3e42;
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 3px;
            text-align: center;
            font-size: 12px;
        }


        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        button:hover {
            background: #1177bb;
        }

        button:active {
            background: #0d5a8f;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* â˜… [ì¶”ê°€] ì‚­ì œ ë²„íŠ¼ ë¹¨ê°•ìƒ‰ ìŠ¤íƒ€ì¼ */
        #deleteBtn {
            background: #f44336; /* ë¹¨ê°• */
        }
        #deleteBtn:hover {
            background: #e53935; /* ì§„í•œ ë¹¨ê°• */
        }
        #deleteBtn:active {
            background: #d32f2f; /* ì•„ì£¼ ì§„í•œ ë¹¨ê°• */
        }


        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-wrapper label {
            background: #0e639c;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            display: inline-block;
        }

        .file-input-wrapper label:hover {
            background: #1177bb;
        }

		/* â˜… [ìˆ˜ì •] ë†’ì´ ê³„ì‚°: status-bar ì œê±°ë¡œ 73px ìœ ì§€ */
		.container {
			display: flex;
			height: calc(100vh - 53px); /* header (53px) */
		}
        
        /* â˜… [ì¶”ê°€] ì•ˆë‚´ ë¬¸êµ¬ ìŠ¤íƒ€ì¼ */
        #autoSaveGuide {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: #fff;
            padding: 8px 20px;
            font-size: 12px;
            z-index: 5000;
            display: none;
            border-top: 1px solid #3e3e42;
        }
        #autoSaveGuide.active {
            display: block;
        }
        #autoSaveGuide .close-btn {
            float: right;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            margin-top: -3px;
        }


        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3e3e42;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            background: #252526;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-info {
            font-size: 13px;
            color: #ccc;
        }

        .file-status {
            font-size: 11px;
            color: #888;
            margin-left: 5px;
        }

        .header-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: #1177bb;
        }

        .header-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .editor-container {
            flex: 1;
            overflow: auto;
            background: #e8e8e8;
            position: relative;
        }

        .line-row {
            display: flex;
            min-height: 18px;
            line-height: 18px;
            font-size: 13px;
        }

        .line-number {
            min-width: 50px;
            padding: 0 8px;
            text-align: right;
            color: #666;
            background: #d0d0d0;
            border-right: 1px solid #999;
            user-select: none;
            flex-shrink: 0;
        }

/* [ì¶”ê°€] í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ì˜ ë Œë”ë§ ì•ˆì •í™” */
        .line-content {
            min-height: 18px;   /* ì¤„ ë†’ì´ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•˜ì—¬ ë¶ˆì•ˆì •í•˜ê²Œ ì¶•ì†Œë˜ëŠ” í˜„ìƒ ë°©ì§€ */
            line-height: 18px;  /* ì¤„ ë†’ì´ ê¸°ì¤€ ëª…í™•í™” */
        }

        .line-row.diff-added .line-content {
            background: #c8f0c8;
        }

        .line-row.diff-removed .line-content {
            background: #f0c8c8;
        }

        .line-row.diff-modified .line-content {
            background: #f0e8c8;
        }

        .line-row.diff-added {
            border-left: 3px solid #4caf50;
        }

        .line-row.diff-removed {
            border-left: 3px solid #f44336;
        }

        .line-row.diff-modified {
            border-left: 3px solid #ff9800;
        }

        .line-row.diff-empty {
            background: #d8d8d8;
        }

        .line-row.diff-empty .line-content {
            background: #d8d8d8;
        }

        .line-row.diff-empty .line-number {
            background: #c0c0c0;
        }

        .line-row.selected {
            background: rgba(14, 99, 156, 0.2) !important;
        }
        
        /* â˜… [ì¶”ê°€] ìš°ì¸¡ íŒ¨ë„ë§Œ ì„ íƒë  ë•Œ ìŠ¤íƒ€ì¼ */
        #rightEditor .line-row.selected {
            background: rgba(14, 99, 156, 0.2) !important;
        }
        
        /* â˜… [ì¶”ê°€] ì¢Œì¸¡ íŒ¨ë„ë§Œ ì„ íƒë  ë•Œ ìŠ¤íƒ€ì¼ */
        #leftEditor .line-row.selected {
            background: rgba(14, 99, 156, 0.2) !important;
        }


        .line-content[contenteditable="true"] {
            cursor: text;
        }

/* [ìˆ˜ì •] í¸ì§‘ í¬ì»¤ìŠ¤ ì‹œ í…Œë‘ë¦¬ ì œê±° (ì¼ë°˜ ì—ë””í„°ì²˜ëŸ¼ ë³€ê²½) */
        .line-content[contenteditable="true"]:focus {
            outline: none; /* íŒŒë€ìƒ‰ ë°•ìŠ¤ í…Œë‘ë¦¬ ì œê±° */
        }

        .search-highlight {
            background: yellow !important;
            color: #000;
            font-weight: normal;
        }

        .search-highlight.current {
            background: orange !important;
            color: #000;
        }

        /* â˜… [ì‚­ì œ] status-bar CSS ì œê±° */
        /* .status-bar { ... } */
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì‚­ì œë¨ */

        /* ë¡œê·¸ íŒ¨ë„ */
        .log-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: #1e1e1e;
            border-top: 1px solid #3e3e42;
            z-index: 3000;
            display: none;
            flex-direction: column;
        }

        .log-panel.active {
            display: flex;
        }

        .log-header {
            background: #252526;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .log-title {
            color: #ccc;
            font-size: 12px;
        }

        .log-content {
            flex: 1;
            overflow: auto;
            padding: 5px;
            font-size: 11px;
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
        }

        .log-entry {
            padding: 2px 5px;
            border-bottom: 1px solid #333;
        }

        .log-entry.error {
            color: #f44336;
        }

        .log-entry.warn {
            color: #fbbf24;
        }

        .log-entry.info {
            color: #4caf50;
        }

        /* ì°¾ê¸°/ë°”ê¾¸ê¸° ë‹¤ì´ì–¼ë¡œê·¸ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
        }

        .dialog-overlay.active {
            display: block;
        }

        .dialog {
            position: fixed;
            top: 15%; /* ìƒë‹¨ì—ì„œ ë„ìš°ê¸° */
            left: 15%; /* ì´ˆê¸° ìœ„ì¹˜ë¥¼ ì™¼ìª½ìœ¼ë¡œ ì„¤ì • */
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 0;
            min-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 2001;
            display: none;
            transition: left 0.3s ease-out; /* ìœ„ì¹˜ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ */
        }

        .dialog.active {
            display: block;
        }

        .dialog-header {
            background: linear-gradient(135deg, #1177bb 0%, #0e639c 100%);
            color: #fff;
            font-size: 16px;
            padding: 12px 20px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .dialog-body {
            padding: 20px;
        }

        .dialog-content {
            margin-bottom: 15px;
        }

        .dialog-row {
            margin-bottom: 10px;
        }

        .dialog-label {
            color: #ccc;
            font-size: 13px;
            margin-bottom: 5px;
            display: block;
        }

        .dialog-input {
            width: 100%;
            padding: 6px 10px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
        }

        .dialog-input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .dialog-btn {
            padding: 8px 16px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .dialog-btn:hover {
            background: #1177bb;
        }

        .dialog-btn.secondary {
            background: #666;
        }

        .dialog-btn.secondary:hover {
            background: #777;
        }
        
        .dialog-btn.active {
            background: #1177bb;
            box-shadow: 0 0 0 2px rgba(17, 119, 187, 0.3);
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ccc;
            font-size: 13px;
            margin-top: 10px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .search-target {
            color: #fbbf24;
            font-size: 12px;
            margin-top: 5px;
        }
		/* [ì¶”ê°€] ì„ íƒëœ ì¤„ì˜ ì¤„ ë²ˆí˜¸ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .line-row.selected .line-number {
            background-color: #0e639c !important; /* ì§„í•œ íŒŒë€ìƒ‰ ë°°ê²½ */
            color: #ffffff !important;           /* í°ìƒ‰ ê¸€ì */
            font-weight: bold;                   /* ê¸€ì êµµê²Œ */
            border-right: 1px solid #005a8d;     /* ê²½ê³„ì„  ìƒ‰ìƒ ë³€ê²½ */
        }

		/* === (1) ë‚´ìš© ë°°ê²½ ì œê±° â€” ì¤‘ìš”!!! === */
		.line-content {
			background: transparent !important;
		}

		/* === (2) ì „ì²´ ì¤„ ë°°ê²½ ìƒ‰ ì ìš© === */
		.line-row.diff-added {
			background: #c8f0c8 !important;
		}
		.line-row.diff-removed {
			background: #f0c8c8 !important;
		}
		.line-row.diff-modified {
			background: #f0e8c8 !important;
		}
		.line-row.diff-empty {
			background: #d8d8d8 !important;
		}

    </style>
</head>
<body>
    <div class="header">
        <div class="title">
            ğŸ” SmartCompare
            <span id="versionString" class="subtitle"></span>
        </div>
        
        <div class="file-controls">
            <button class="header-btn" id="copyToRightBtn" title="ì„ íƒí•œ ë¸”ë¡ì„ ìš°ì¸¡ìœ¼ë¡œ ë³µì‚¬">â†’ ìš°ì¸¡ìœ¼ë¡œ ë³µì‚¬</button>
            <button class="header-btn" id="findLeftOnlyBtn" title="ì™¼ìª½ íŒŒì¼ì—ì„œ ì°¾ê¸° (Ctrl+F)">ğŸ” ì¢Œì¸¡ ì°¾ê¸°</button>
            <button class="header-btn" id="findRightOnlyBtn" title="ì˜¤ë¥¸ìª½ íŒŒì¼ì—ì„œ ì°¾ê¸° (Ctrl+F)">ğŸ” ìš°ì¸¡ ì°¾ê¸°</button>
            <button class="header-btn" id="deleteBtn" title="ì„ íƒí•œ ì¤„ì„ ìš°ì¸¡ íŒŒì¼ì—ì„œ ì‚­ì œ">ğŸ—‘ï¸ ì‚­ì œ</button> 
            
            <div class="auto-save-control">
                <label for="autoSaveSecondsInput">ì €ì¥ ì£¼ê¸° (ë¶„):</label>
                <input type="range" id="autoSaveSecondsInput" min="1" max="20" step="1" value="10"> 
                <span id="autoSaveCurrentValue">10ë¶„</span> 
            </div>
        </div>
        
        <div class="controls">
            <button id="undoBtn" title="ì‹¤í–‰ ì·¨ì†Œ (Ctrl+Z)">â†¶ ì‹¤í–‰ ì·¨ì†Œ</button>
            <button id="redoBtn" title="ì¬ì‹¤í–‰ (Ctrl+Y)">â†· ì¬ì‹¤í–‰</button>
            <button id="toggleLogBtn">ğŸ“‹ ë¡œê·¸</button>
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-header-left">
                    <span class="file-info">
                        <span id="leftFileName">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>
                        <span class="file-status">(ì½ê¸° ì „ìš©)</span>
                    </span>
                </div>
                <div class="panel-header-right">
                    <div class="file-input-wrapper">
                        <input type="file" id="leftFile" accept=".txt,.md,.js,.html,.css,.json,.xml,.log,.py">
                        <label for="leftFile" class="header-btn">íŒŒì¼ ì—´ê¸°</label>
                    </div>
                </div>
            </div>
            <div class="editor-container" id="leftEditor" data-panel="left"></div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-header-left">
                    <span class="file-info">
                        <span id="rightFileName">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>
                        <span class="file-status">(í¸ì§‘ ê°€ëŠ¥)</span>
                    </span>
                </div>
                <div class="panel-header-right">
                    <div class="file-input-wrapper">
                        <input type="file" id="rightFile" accept=".txt,.md,.js,.html,.css,.json,.xml,.log,.py">
                        <label for="rightFile" class="header-btn">íŒŒì¼ ì—´ê¸°</label>
                    </div>
                    <button class="header-btn" id="saveBtn" title="ì €ì¥ (Ctrl+S)">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
            <div class="editor-container" id="rightEditor" data-panel="right"></div>
        </div>
    </div>
    
    <div class="log-panel" id="logPanel">
        <div class="log-header">
            <span class="log-title">ğŸ“‹ ë””ë²„ê·¸ ë¡œê·¸</span>
            <button class="header-btn" id="clearLogBtn">Clear</button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>

    <div class="dialog-overlay" id="findOverlay"></div>
    <div class="dialog" id="findDialog">
        <div class="dialog-header">ğŸ” ì°¾ê¸°</div>
        <div class="dialog-body">
            <div class="dialog-content">
                <div class="dialog-row">
                    <label class="dialog-label">ì°¾ì„ ë‚´ìš©:</label>
                    <input type="text" class="dialog-input" id="findInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
                </div>
                <div class="search-target" id="findTarget"></div>
                <div class="checkbox-group">
                    <div class="checkbox-row">
                        <input type="checkbox" id="findCaseSensitive">
                        <label for="findCaseSensitive">ëŒ€ì†Œë¬¸ì êµ¬ë¶„</label>
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="findWholeWord">
                        <label for="findWholeWord">ë‹¨ì–´ ì „ì²´ ì¼ì¹˜</label>
                    </div>
                </div>
            </div>
            <div class="dialog-buttons">
                <button class="dialog-btn" id="findNextBtn">ë‹¤ìŒ ì°¾ê¸°</button>
                <button class="dialog-btn" id="findPrevBtn">ì´ì „ ì°¾ê¸°</button>
                <button class="dialog-btn secondary" id="findCloseBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <div id="autoSaveGuide">
        <button class="close-btn" onclick="document.getElementById('autoSaveGuide').classList.remove('active');">âœ•</button>
        **[ì•ˆë‚´]** íŒŒì¼ ìë™ ì €ì¥/ìˆ˜ë™ ì €ì¥ ì‹œ ë‹¤ìš´ë¡œë“œ í™•ì¸ ì°½ì´ ëœ¨ëŠ” ê²ƒì„ ë§‰ìœ¼ë ¤ë©´, ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì„¤ì •ì„ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤. 
        <br>ğŸ‘‰ **Chrome ê¸°ì¤€:** ì„¤ì • > ë‹¤ìš´ë¡œë“œ > 'ë‹¤ìš´ë¡œë“œ ì „ì— ê° íŒŒì¼ ì €ì¥ ìœ„ì¹˜ í™•ì¸'ì„ **ë¹„í™œì„±í™”**í•˜ì„¸ìš”.
    </div>

    <script>
        // â˜… [ìˆ˜ì •] ìë™ ì €ì¥ ì£¼ê¸° ì„¤ì • (1ë¶„ ~ 20ë¶„) - ì´ˆê¸°ê°’ 10ë¶„
        const DEFAULT_AUTO_SAVE_MINUTES = 10;
        const LOCAL_STORAGE_KEY = 'autoSaveMinutes';
        
        // --- ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ ë²„ì „ ë¬¸ìì—´ ì •ì˜ ---
        const VERSION_STRING = '(ì£¼)íŒŒì›Œì ¬ V251202_ìœ íš¨ì—´'; 
        // ------------------------------------
        
        // ì œëª© ë¬¸ìì—´ ì‚½ì…
        document.getElementById('versionString').textContent = VERSION_STRING;
        
        
        // ë¡œê·¸ ì‹œìŠ¤í…œ
        class Logger {
            // ... (Logger í´ë˜ìŠ¤ ë‚´ìš©ì€ ì´ì „ê³¼ ë™ì¼)
            constructor() {
                this.logs = [];
                this.maxLogs = 100;
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = { timestamp, message, type };
                this.logs.push(logEntry);
                
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }

                this.render();
                console.log(`[${type.toUpperCase()}] ${timestamp} - ${message}`);
            }

            info(message) {
                this.log(message, 'info');
            }

            warn(message) {
                this.log(message, 'warn');
            }

            error(message) {
                this.log(message, 'error');
            }

            render() {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    logContent.innerHTML = this.logs.map(log => 
                        `<div class="log-entry ${log.type}">[${log.timestamp}] ${log.message}</div>`
                    ).join('');
                    logContent.scrollTop = logContent.scrollHeight;
                }
            }

            clear() {
                this.logs = [];
                this.render();
            }
        }

        const logger = new Logger();

        // Myers Diff ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
        class MyersDiff {
			constructor(left, right) {
                // ì›ë³¸ ì½”ë“œëŠ” ê³µë°± ì •ê·œí™”ë¥¼ ìƒì„±ìì—ì„œ í–ˆìœ¼ë‚˜,
                // SmartCompare í´ë˜ìŠ¤ì—ì„œ ë¼ì¸ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                this.left = left.map(line => line.replace(/\s+/g, ' ').trim());
                this.right = right.map(line => line.replace(/\s+/g, ' ').trim());
            }

            compute() {
                const n = this.left.length;
                const m = this.right.length;
                const max = n + m;
                const v = {};
                const trace = [];

                v[1] = 0;
                for (let d = 0; d <= max; d++) {
                    trace.push({...v});
					for (let k = -d; k <= d; k += 2) {
                        let x;
                        if (k === -d || (k !== d && v[k - 1] < v[k + 1])) {
                            x = v[k + 1];
                        } else {
                            x = v[k - 1] + 1;
                        }
                        let y = x - k;

                        while (x < n && y < m) {
                            const leftNorm = this.left[x].replace(/\s+/g, ' ').trim();
                            const rightNorm = this.right[y].replace(/\s+/g, ' ').trim();
                            // console.log(`ë¹„êµ [${x},${y}]:`, JSON.stringify(this.left[x]), 'vs', JSON.stringify(this.right[y]));
                            // console.log(`ì •ê·œí™”:`, JSON.stringify(leftNorm), 'vs', JSON.stringify(rightNorm), 'ê°™ìŒ:', leftNorm === rightNorm);
                            if (leftNorm !== rightNorm) break;
                            x++;
                            y++;
                        }

                        v[k] = x;

                        if (x >= n && y >= m) {
                            return this.backtrack(trace, n, m);
                        }
                    }
                }
                return this.backtrack(trace, n, m);
            }

            backtrack(trace, n, m) {
                const result = [];
                let x = n;
                let y = m;

                for (let d = trace.length - 1; d >= 0; d--) {
                    const v = trace[d];
                    const k = x - y;

                    let prevK;
                    if (k === -d || (k !== d && v[k - 1] < v[k + 1])) {
                        prevK = k + 1;
                    } else {
                        prevK = k - 1;
                    }

                    const prevX = v[prevK];
                    const prevY = prevX - prevK;

                    while (x > prevX && y > prevY) {
                        result.unshift({ type: 'equal', leftIdx: x - 1, rightIdx: y - 1 });
                        x--;
                        y--;
                    }

                    if (d > 0) {
                        if (x === prevX) {
                            result.unshift({ type: 'added', leftIdx: -1, rightIdx: y - 1 });
                            y--;
                        } else {
                            result.unshift({ type: 'removed', leftIdx: x - 1, rightIdx: -1 });
                            x--;
                        }
                    }
                }

                return result;
            }
        }

        class UltraCompare {
            constructor() {
                this.leftContent = '';
                this.rightContent = '';
                this.leftFile = null;
                this.rightFile = null;
                this.rightFileName = '';
                this.diffBlocks = [];
                this.currentDiffIndex = -1;
                this.selectedDiffBlocks = [];  // ë³µìˆ˜ ì„ íƒ ì§€ì›
                this.lastFocusedPanel = 'right';
                
                // Undo/Redo ìŠ¤íƒ
                this.undoStack = [];
                this.redoStack = [];
                this.maxUndoStack = 50;
                
                // ìš°ì¸¡ íŒŒì¼ ë³´í˜¸ ìƒíƒœ
                this.isRightEditable = false;
                
                // ìë™ ì €ì¥ ê´€ë ¨
                this.backupPath = null;
                this.lastSavedContent = ''; // â˜… ìµœì¢… ë°±ì—…ëœ ë‚´ìš©
                this.autoSaveIntervalId = null; // â˜… ìë™ ì €ì¥ íƒ€ì´ë¨¸ ID
                
                // ì°¾ê¸°/ë°”ê¾¸ê¸°
                this.searchResults = [];
                this.currentSearchIndex = -1;
                this.searchPanel = 'right';
                
                this.init();
            }

            init() {
				const leftEditor = document.getElementById('leftEditor');
                
				leftEditor.addEventListener("keydown", (e) => {
					if (e.code === "Space") {
						e.preventDefault();
						return false;
					}
				});

				/* ---------------------- ìŠ¤í¬ë¡¤ ë³´ì¡° ì°¨ë‹¨ (window/wheel) ---------------------- */
				leftEditor.addEventListener("wheel", (e) => {
					// ì™¼ìª½ ì°½ì´ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ë§ˆìš°ìŠ¤ íœ  ìŠ¤í¬ë¡¤ ë°©ì§€
					if (document.activeElement === leftEditor) {
						e.preventDefault();
					}
				}, { passive: false });
	
                logger.info('SmartCompare ì´ˆê¸°í™”');
                
                // â˜… [ìˆ˜ì •] ìë™ ì €ì¥ ì£¼ê¸° ì„¤ì • ë¡œì§
                this.loadAutoSaveSetting();
                
                const inputElement = document.getElementById('autoSaveSecondsInput');
                const currentValueSpan = document.getElementById('autoSaveCurrentValue');
                
                if (inputElement) {
                    // ì´ˆê¸°ê°’ í‘œì‹œ
                    currentValueSpan.textContent = `${inputElement.value}ë¶„`;
                    
                    // ìŠ¬ë¼ì´ë“œ ë°” ê°’ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ í‘œì‹œ
                    inputElement.addEventListener('input', (e) => {
                        currentValueSpan.textContent = `${e.target.value}ë¶„`;
                    });
                    
                    // ìŠ¬ë¼ì´ë“œ ë°” ì‚¬ìš© ì™„ë£Œ(change) ì‹œ ì„¤ì • ì €ì¥ ë° íƒ€ì´ë¨¸ ì¬ì‹œì‘
                    inputElement.addEventListener('change', () => this.saveAutoSaveSetting());
                }
                
                // ë¡œê·¸ ë²„íŠ¼
                document.getElementById('toggleLogBtn').addEventListener('click', () => this.toggleLog());
                document.getElementById('clearLogBtn').addEventListener('click', () => logger.clear());
                
                // íŒŒì¼ í•¸ë“¤ëŸ¬
                document.getElementById('leftFile').addEventListener('change', (e) => this.handleLeftFile(e));
                document.getElementById('rightFile').addEventListener('change', (e) => this.handleRightFile(e));
                
                // ê¸°ë³¸ ë²„íŠ¼
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo());
                
                // í—¤ë”ì— ë¶„ë¦¬ëœ ì°¾ê¸° ë²„íŠ¼
                document.getElementById('copyToRightBtn').addEventListener('click', () => this.copyToRight());
                // â˜… [ìˆ˜ì •] ID ë³€ê²½
                document.getElementById('deleteBtn').addEventListener('click', () => this.deleteSelectedLines()); 
                document.getElementById('findLeftOnlyBtn').addEventListener('click', () => this.openFindDialog('left')); // ì¢Œì¸¡ ì°¾ê¸°
                document.getElementById('findRightOnlyBtn').addEventListener('click', () => this.openFindDialog('right')); // ìš°ì¸¡ ì°¾ê¸°
                
                // ì €ì¥ ë²„íŠ¼ (ìˆ˜ì •ë¨)
                document.getElementById('saveBtn').addEventListener('click', () => this.saveFile());
                
                // ì°¾ê¸° ë‹¤ì´ì–¼ë¡œê·¸
                document.getElementById('findNextBtn').addEventListener('click', () => this.findNext());
                document.getElementById('findPrevBtn').addEventListener('click', () => this.findPrev());
                document.getElementById('findCloseBtn').addEventListener('click', () => this.closeFindDialog());
                document.getElementById('findOverlay').addEventListener('click', () => this.closeFindDialog());
                
                // íŒ¨ë„ í¬ì»¤ìŠ¤ ì¶”ì 
                document.getElementById('leftEditor').addEventListener('mouseenter', () => {
                    this.lastFocusedPanel = 'left';
                });
                document.getElementById('rightEditor').addEventListener('mouseenter', () => {
                    this.lastFocusedPanel = 'right';
                });
                
                // â˜… [ì¶”ê°€] ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš© (ID ë³€ê²½ì— ë§ì¶°)
                const deleteButton = document.getElementById('deleteBtn');
                if (deleteButton) {
                    deleteButton.style.background = '#f44336'; 
                    deleteButton.onmouseover = () => deleteButton.style.background = '#e53935';
                    deleteButton.onmouseout = () => deleteButton.style.background = '#f44336';
                    deleteButton.onmousedown = () => deleteButton.style.background = '#d32f2f';
                }

                // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
                document.addEventListener('keydown', (e) => {
                    // Ctrl+Z: Undo
                    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        this.undo();
                    } 
                    // Ctrl+Shift+Z ë˜ëŠ” Ctrl+Y: Redo
                    else if ((e.ctrlKey && e.shiftKey && e.key === 'Z') || (e.ctrlKey && e.key === 'y')) {
                        e.preventDefault();
                        this.redo();
                    } 
                    // Ctrl+S: ì €ì¥
                    else if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        this.saveFile(); // â˜… [ìˆ˜ì •] Ctrl+S ì…ë ¥ ì‹œ saveFile í˜¸ì¶œ
                    } 
                    // Ctrl+F: ì°¾ê¸°
                    else if (e.ctrlKey && e.key === 'f') {
                        e.preventDefault();
                        this.openFindDialog(this.lastFocusedPanel || 'right');
                    } 
                    // Space: ìŠ¤í¬ë¡¤ ë°©ì§€ (ì „ì²´ì ìœ¼ë¡œ)
                    else if (e.key === ' ' || e.code === 'Space') {
                        e.preventDefault();
                        return false;
                    }
                });

                // Space í‚¤ ì „ì—­ ë°©ì§€ (í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨)
                window.addEventListener('keydown', (e) => {
                    if (e.key === ' ' || e.code === 'Space') {
                        // ì…ë ¥ í•„ë“œì—ì„œëŠ” Space í—ˆìš©
                        const activeElement = document.activeElement;
                        const isInputField = activeElement && (
                            activeElement.tagName === 'INPUT' || 
                            activeElement.tagName === 'TEXTAREA' ||
                            activeElement.isContentEditable
                        );
                        
                        if (!isInputField) {
                            e.preventDefault();
                            return false;
                        }
                    }
                }, { passive: false });

                // â˜… [ì‚­ì œ] status-bar ê´€ë ¨ ì´ˆê¸°í™” ë¡œì§ ì œê±°
                this.updateStatus('ì¤€ë¹„ë¨');
                this.updateUndoRedoButtons();
            }
            
            // â˜… [ìˆ˜ì •] ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (ë¶„ ë‹¨ìœ„)
            loadAutoSaveSetting() {
                const savedMinutes = localStorage.getItem(LOCAL_STORAGE_KEY);
                
                const inputElement = document.getElementById('autoSaveSecondsInput');
                const currentValueSpan = document.getElementById('autoSaveCurrentValue');

                if (inputElement) {
                    let minutes;
                    if (savedMinutes === null) {
                        minutes = DEFAULT_AUTO_SAVE_MINUTES;
                    } else {
                        // 1ë¶„~20ë¶„ ë²”ìœ„ ì ìš©
                        minutes = Math.max(1, Math.min(20, parseInt(savedMinutes)));
                    }
                    inputElement.value = minutes;
                    if (currentValueSpan) {
                         currentValueSpan.textContent = `${minutes}ë¶„`; // ìŠ¤íŒ¬ ê°’ ê°±ì‹ 
                    }
                }
            }
            
            // â˜… [ìˆ˜ì •] ì„¤ì • ì €ì¥í•˜ê¸° (ë¶„ ë‹¨ìœ„)
            saveAutoSaveSetting() {
                const inputElement = document.getElementById('autoSaveSecondsInput');
                if (inputElement) {
                    let minutes = parseInt(inputElement.value);
                    // 1ë¶„~20ë¶„ ì œí•œ
                    minutes = Math.max(1, Math.min(20, minutes)); 
                    inputElement.value = minutes;
                    localStorage.setItem(LOCAL_STORAGE_KEY, minutes);
                    logger.info(`ì €ì¥ ì£¼ê¸° ì„¤ì •ë¨: ${minutes}ë¶„`);
                    
                    // ì„¤ì • ë³€ê²½ í›„ ìë™ ì €ì¥ íƒ€ì´ë¨¸ ì¬ì‹œì‘
                    if (this.autoSaveIntervalId || this.rightContent) {
                        this.startAutoSaveCheck();
                    }
                }
            }
            
            // â˜… [ìˆ˜ì •] ìë™ ì €ì¥ ê²€ì‚¬ ì‹œì‘ (ë¶„ ë‹¨ìœ„)
            startAutoSaveCheck() {
                // ì´ì „ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ í´ë¦¬ì–´
                if (this.autoSaveIntervalId) {
                    clearInterval(this.autoSaveIntervalId);
                }
                
                // ì„¤ì •ëœ ë¶„ ê°’ ê°€ì ¸ì˜¤ê¸°
                const inputElement = document.getElementById('autoSaveSecondsInput');
                const minutes = inputElement ? Math.max(1, Math.min(20, parseInt(inputElement.value))) : DEFAULT_AUTO_SAVE_MINUTES;
                
                // â˜… [ìˆ˜ì •] ë¶„ ë‹¨ìœ„ë¥¼ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜ (minutes * 60ì´ˆ * 1000ms)
                const intervalMs = minutes * 60 * 1000; 
                
                this.autoSaveIntervalId = setInterval(() => {
                    this.checkAndBackupFile();
                }, intervalMs);
                
                logger.info(`ìë™ ì €ì¥ ê²€ì‚¬ ì‹œì‘ (ì£¼ê¸°: ${minutes}ë¶„)`);
            }
            
            // â˜… [ì¶”ê°€] ìˆ˜ì • ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ë°±ì—…
            checkAndBackupFile() {
                if (!this.rightContent || !this.rightFileName) {
                    // ì˜¤ë¥¸ìª½ íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¤‘ë‹¨
                    return;
                }
                
                // í˜„ì¬ ë‚´ìš©ì´ ë§ˆì§€ë§‰ ì €ì¥ ë‚´ìš©ê³¼ ë‹¤ë¥¼ ë•Œë§Œ ë°±ì—…
                if (this.rightContent !== this.lastSavedContent) {
                    this.backupFile();
                }
            }


            toggleLog() {
                const logPanel = document.getElementById('logPanel');
                logPanel.classList.toggle('active');
            }

            getSelectedText() {
                const selection = window.getSelection();
                if (selection && selection.toString().trim()) {
                    return selection.toString().trim();
                }
                return '';
            }

            handleLeftFile(e) {
                const file = e.target.files[0];
                if (file) {
                    logger.info(`ì™¼ìª½ íŒŒì¼ ë¡œë“œ ì‹œì‘: ${file.name}`);
                    this.leftFile = file;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.leftContent = event.target.result;
                        logger.info(`ì™¼ìª½ íŒŒì¼ ë‚´ìš© ê¸¸ì´: ${this.leftContent.length} ë¬¸ì`);
                        
                        // â˜… [ìˆ˜ì •] ì™¼ìª½ íŒŒì¼ ì´ë¦„ í‘œì‹œ
                        document.getElementById('leftFileName').textContent = file.name;
                        
                        this.updateStatus(`ì™¼ìª½ íŒŒì¼ ë¡œë“œë¨: ${file.name}`);
                        
                        // ì™¼ìª½ íŒŒì¼ë§Œ ìˆì–´ë„ í‘œì‹œ
                        if (this.rightContent) {
                            this.autoCompare();
                        } else {
                            this.renderLeftOnly();
                        }
                    };
                    reader.readAsText(file);
                }
            }

            handleRightFile(e) {
                const file = e.target.files[0];
                if (file) {
                    logger.info(`ì˜¤ë¥¸ìª½ íŒŒì¼ ë¡œë“œ ì‹œì‘: ${file.name}`);
                    this.rightFile = file;
                    this.rightFileName = file.name;
                    this.backupPath = file.name.substring(0, file.name.lastIndexOf('.')); // í™•ì¥ì ì•ê¹Œì§€ ê²½ë¡œ/ì´ë¦„ ì €ì¥
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.rightContent = event.target.result;
                        
                        // â˜… [ìˆ˜ì •] íŒŒì¼ ë¡œë“œ ì§í›„ ì›ë³¸ ìƒíƒœë¥¼ Undo ìŠ¤íƒì˜ ì²« ë²ˆì§¸ í•­ëª©ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                        this.undoStack = [this.rightContent];
                        this.redoStack = [];
                        this.updateUndoRedoButtons();
                        
                        // â˜… [ìˆ˜ì •] ë§ˆì§€ë§‰ ì €ì¥ ë‚´ìš©ì„ í˜„ì¬ ë‚´ìš©ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ê³  ìë™ ì €ì¥ ê²€ì‚¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
                        this.lastSavedContent = this.rightContent; 
                        this.startAutoSaveCheck();
                        
                        // â˜… [ì¶”ê°€] ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
                        document.getElementById('autoSaveGuide').classList.add('active');

                        // ìš°ì¸¡ íŒŒì¼ ë¡œë“œ ì‹œ ë³´í˜¸ ìƒíƒœ ì´ˆê¸°í™” (í¸ì§‘ ë¶ˆê°€)
                        this.isRightEditable = false;
                        
                        logger.info(`ì˜¤ë¥¸ìª½ íŒŒì¼ ë‚´ìš© ê¸¸ì´: ${this.rightContent.length} ë¬¸ì`);
                        document.getElementById('rightFileName').textContent = file.name;
                        this.updateStatus(`ì˜¤ë¥¸ìª½ íŒŒì¼ ë¡œë“œë¨: ${file.name} (ë³´í˜¸ë¨ - ì¢Œâ†’ìš° ë³µì‚¬ í›„ í¸ì§‘ ê°€ëŠ¥)`);
                        this.autoCompare();
                    };
                    reader.readAsText(file);
                }
            }

            renderLeftOnly() {
                logger.info('ì™¼ìª½ íŒŒì¼ë§Œ ë Œë”ë§');
                const leftEditor = document.getElementById('leftEditor');
                const leftLines = this.leftContent.split('\n');
                
                let leftHTML = '';
                leftLines.forEach((line, i) => {
                    const content = this.escapeHtml(line);
                    leftHTML += `<div class="line-row">
                        <div class="line-number">${i + 1}</div>
                        <div class="line-content">${content || ' '}</div>
                    </div>`;
                });
                
                leftEditor.innerHTML = leftHTML;
                this.attachClickListeners();
            }

            autoCompare() {
                if (this.leftContent && this.rightContent) {
                    logger.info('ìë™ ë¹„êµ ì‹¤í–‰');
                    this.compare();
                }
            }

            compare() {
                logger.info('ë¹„êµ ì‹œì‘');
                if (!this.leftContent && !this.rightContent) {
                    this.updateStatus('ë¹„êµí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                const leftLines = this.leftContent.split('\n');
                const rightLines = this.rightContent.split('\n');
/*<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<*/
				// === ê³µë°± ì •ê·œí™”: íƒ­ â†’ ê³µë°± 4ì¹¸, ë ê³µë°± ì œê±° ===
				const normalize = (line) =>
					line.replace(/\t/g, "    ")   // íƒ­ì„ ê³µë°± 4ê°œë¡œ ë³€í™˜
						.replace(/\s+$/g, "");    // ì¤„ ë ê³µë°± ì œê±°

				const leftNorm = leftLines.map(normalize);
				const rightNorm = rightLines.map(normalize);
/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

                logger.info(`ì™¼ìª½ ë¼ì¸ ìˆ˜: ${leftLines.length}, ì˜¤ë¥¸ìª½ ë¼ì¸ ìˆ˜: ${rightLines.length}`);

                const differ = new MyersDiff(leftNorm, rightNorm);
                const diffResult = differ.compute();

                logger.info(`Diff ê²°ê³¼: ${diffResult.length} í•­ëª©`);

                this.renderComparison(diffResult, leftLines, rightLines);

                // â˜… [ì‚­ì œ] updateDiffStats í˜¸ì¶œ ì œê±°
                // const stats = this.calculateStats(diffResult);
                // this.updateDiffStats(stats);
                
                logger.info('ë¹„êµ ì™„ë£Œ');
            }

            renderComparison(diffResult, leftLines, rightLines) {
                logger.info('ë Œë”ë§ ì‹œì‘');
                
                const leftEditor = document.getElementById('leftEditor');
                const rightEditor = document.getElementById('rightEditor');

                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì™€ í¬ì»¤ìŠ¤ ì €ì¥
                const scrollTop = rightEditor.scrollTop;
                const activeElement = document.activeElement;
                const activeLineNumber = activeElement && activeElement.classList.contains('line-content') ? 
                    activeElement.dataset.line : null;
                const cursorPosition = activeElement ? this.getCursorPosition(activeElement) : 0;
                
                logger.info(`ìŠ¤í¬ë¡¤ ìœ„ì¹˜: ${scrollTop}, í™œì„± ë¼ì¸: ${activeLineNumber}, ì»¤ì„œ ìœ„ì¹˜: ${cursorPosition}`);

                let leftHTML = '';
                let rightHTML = '';
                
                let leftLineNum = 1;
                let rightLineNum = 1;

                // ê¸°ì¡´ ì„ íƒ ìƒíƒœ ì €ì¥ì„ ìœ„í•´ data-indexë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„ íƒëœ ë¸”ë¡ì„ ì°¾ìŠµë‹ˆë‹¤.
                const selectedIndices = new Set(this.selectedDiffBlocks.map(b => b.index));

                for (let i = 0; i < diffResult.length; i++) {
                    const item = diffResult[i];
                    const isSelected = selectedIndices.has(i.toString()) ? ' selected' : '';

                    if (item.type === 'equal') {
                        const leftContent = this.escapeHtml(leftLines[item.leftIdx]);
                        const rightContent = this.escapeHtml(rightLines[item.rightIdx]);

                        leftHTML += `<div class="line-row${isSelected}" data-index="${i}" data-panel="left" data-type="equal">
                            <div class="line-number">${leftLineNum}</div>
                            <div class="line-content">${leftContent || ' '}</div>
                        </div>`;

                        rightHTML += `<div class="line-row${isSelected}" data-index="${i}" data-panel="right" data-type="equal">
                            <div class="line-number">${rightLineNum}</div>
                            <div class="line-content" contenteditable="${this.isRightEditable}" data-line="${rightLineNum}">${rightContent || ' '}</div>
                        </div>`;

                        leftLineNum++;
                        rightLineNum++;

                    } else if (item.type === 'removed') {
                        const leftContent = this.escapeHtml(leftLines[item.leftIdx]);

                        leftHTML += `<div class="line-row diff-removed${isSelected}" data-index="${i}" data-panel="left" data-type="removed">
                            <div class="line-number">${leftLineNum}</div>
                            <div class="line-content">${leftContent || ' '}</div>
                        </div>`;

                        rightHTML += `<div class="line-row diff-empty${isSelected}" data-index="${i}" data-panel="right" data-type="empty">
                            <div class="line-number"></div>
                            <div class="line-content"> </div>
                        </div>`;

                        leftLineNum++;

                    } else if (item.type === 'added') {
                        const rightContent = this.escapeHtml(rightLines[item.rightIdx]);

                        leftHTML += `<div class="line-row diff-empty${isSelected}" data-index="${i}" data-panel="left" data-type="empty">
                            <div class="line-number"></div>
                            <div class="line-content"> </div>
                        </div>`;

                        rightHTML += `<div class="line-row diff-added${isSelected}" data-index="${i}" data-panel="right" data-type="added">
                            <div class="line-number">${rightLineNum}</div>
                            <div class="line-content" contenteditable="${this.isRightEditable}" data-line="${rightLineNum}">${rightContent || ' '}</div>
                        </div>`;

                        rightLineNum++;
                    }
                }

                leftEditor.innerHTML = leftHTML;
                rightEditor.innerHTML = rightHTML;

                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
                rightEditor.scrollTop = scrollTop;
 
                logger.info('DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ');

                this.attachEditListeners();
                this.attachClickListeners();
                this.syncScroll();
                
                logger.info('ë Œë”ë§ ì™„ë£Œ');
            }

            getCursorPosition(element) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    return preCaretRange.toString().length;
                }
                return 0;
            }

            setCursorPosition(element, position) {
                const range = document.createRange();
                const sel = window.getSelection();
                
                try {
                    let charIndex = 0;
                    let nodeStack = [element];
                    let node;
                    let foundStart = false;

                    while (!foundStart && (node = nodeStack.pop())) {
                        if (node.nodeType === 3) { // TEXT_NODE
                            const nextCharIndex = charIndex + node.length;
                            if (position >= charIndex && position <= nextCharIndex) {
                                range.setStart(node, position - charIndex);
                                range.collapse(true);
                                foundStart = true;
                            }
                            charIndex = nextCharIndex;
                        } else {
                            let i = node.childNodes.length;
                            while (i--) {
                                nodeStack.push(node.childNodes[i]);
                            }
                        }
                    }

                    if (!foundStart) {
                        range.selectNodeContents(element);
                        range.collapse(false);
                    }

                    sel.removeAllRanges();
                    sel.addRange(range);
                } catch (e) {
                    logger.error(`ì»¤ì„œ ìœ„ì¹˜ ì„¤ì • ì‹¤íŒ¨: ${e.message}`);
                }
            }

            attachEditListeners() {
                logger.info('í¸ì§‘ ë¦¬ìŠ¤ë„ˆ ë¶€ì°© ì‹œì‘');
                const rightEditor = document.getElementById('rightEditor');
                const editableLines = rightEditor.querySelectorAll('.line-content[contenteditable="true"]');

                logger.info(`í¸ì§‘ ê°€ëŠ¥ ë¼ì¸ ìˆ˜: ${editableLines.length}`);

                editableLines.forEach((line, index) => {
					line.addEventListener('focus', () => {
                        // ìš°ì¸¡ íŒŒì¼ì´ ë³´í˜¸ ìƒíƒœì´ë©´ í¬ì»¤ìŠ¤ í•´ì œ
                        if (!this.isRightEditable) {
                            line.blur();
                            this.updateStatus('ìš°ì¸¡ íŒŒì¼ì€ ë³´í˜¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¢Œì¸¡ì—ì„œ ìš°ì¸¡ìœ¼ë¡œ ë³µì‚¬ í›„ í¸ì§‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                            return;
                        }
						line._originalText = line.textContent;
					});

					line.addEventListener("blur", () => {
                        // ìš°ì¸¡ íŒŒì¼ì´ ë³´í˜¸ ìƒíƒœì´ë©´ ë³€ê²½ì‚¬í•­ ë¬´ì‹œ
                        if (!this.isRightEditable) {
                            return;
                        }
                        
						const newText = line.textContent;
						const oldText = line._originalText;

						if (newText !== oldText) {
							this.saveToUndoStack();
                            // blur ì‹œ ì¦‰ì‹œ ë°±ì—…í•˜ëŠ” ë¡œì§ ì œê±°. ìë™ ì €ì¥ ë£¨í‹´ì— ë§¡ê¹€. 

							const idx = parseInt(line.dataset.line) - 1;
							const arr = this.rightContent.split("\n");
							arr[idx] = newText;
							this.rightContent = arr.join("\n");
						}
					});


                    line.addEventListener('input', (e) => {
                        logger.info(`ë¼ì¸ ${line.dataset.line} ì…ë ¥: "${e.target.textContent}"`);
                    });

                    line.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            logger.info('Enter í‚¤ ì°¨ë‹¨');
                        }
                    });
                });

                logger.info('í¸ì§‘ ë¦¬ìŠ¤ë„ˆ ë¶€ì°© ì™„ë£Œ');
            }


			attachClickListeners() {
                const allRows = document.querySelectorAll('.line-row');
                
                // ë²”ìœ„ ì„ íƒì„ ìœ„í•œ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
                if (typeof this.lastSelectedIndex === 'undefined') {
                    this.lastSelectedIndex = null;
                }

                allRows.forEach(row => {
                    const lineNumber = row.querySelector('.line-number');
                    const panel = row.dataset.panel;
                    
                    if (lineNumber) {
                        lineNumber.style.cursor = 'pointer';

                        // [ê¸°ëŠ¥ ìˆ˜ì •] í´ë¦­ ì´ë²¤íŠ¸: ì¤„ ì„ íƒ (ë‹¨ì¼/ë‹¤ì¤‘/ë²”ìœ„)
                        lineNumber.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            const index = parseInt(row.dataset.index);
                            const clickedPanel = row.dataset.panel;
                            
                            // 1. Shift + í´ë¦­: ë²”ìœ„ ì„ íƒ
                            if (e.shiftKey && this.lastSelectedIndex !== null) {
                                const start = Math.min(this.lastSelectedIndex, index);
                                const end = Math.max(this.lastSelectedIndex, index);

                                this.selectedDiffBlocks = [];
                                document.querySelectorAll('.line-row.selected').forEach(r => r.classList.remove('selected'));
                                
                                // í´ë¦­ëœ íŒ¨ë„ì—ë§Œ í•˜ì´ë¼ì´íŠ¸ ì ìš©
                                const targetEditorId = clickedPanel === 'left' ? '#leftEditor' : '#rightEditor';


                                for (let i = start; i <= end; i++) {
                                    const targetRow = document.querySelector(`${targetEditorId} .line-row[data-index="${i}"]`);

                                    if (targetRow) {
                                        this.selectedDiffBlocks.push({ index: i.toString(), row: targetRow, panel: targetRow.dataset.panel });
                                        targetRow.classList.add('selected');
                                    }
                                }
                                logger.info(`ë²”ìœ„ ì„ íƒë¨: ${start} ~ ${end} (${targetEditorId})`);
                                this.lastFocusedPanel = clickedPanel; // ë§ˆì§€ë§‰ í¬ì»¤ìŠ¤ íŒ¨ë„ ì—…ë°ì´íŠ¸

                            // 2. Ctrl + í´ë¦­: ê°œë³„ ë‹¤ì¤‘ ì„ íƒ
                            } else if (e.ctrlKey || e.metaKey) {
                                // í˜„ì¬ ì¤„ì´ ì´ë¯¸ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
                                const blockIndex = this.selectedDiffBlocks.findIndex(b => parseInt(b.index) === index);
                                
                                // ì´ì „ì— ì„ íƒëœ ë¸”ë¡ì´ ì—†ìœ¼ë©´ í˜„ì¬ í´ë¦­ëœ íŒ¨ë„ì„ ê¸°ì¤€ íŒ¨ë„ë¡œ ì„¤ì •
                                if (this.selectedDiffBlocks.length === 0) {
                                    this.lastFocusedPanel = clickedPanel;
                                }
                                const targetPanel = this.lastFocusedPanel; // í˜„ì¬ ì‘ì—… ì¤‘ì¸ íŒ¨ë„

                                const targetRow = document.querySelector(`#${targetPanel}Editor .line-row[data-index="${index}"]`);

                                if (blockIndex >= 0) {
                                    // ì„ íƒ í•´ì œ
                                    this.selectedDiffBlocks.splice(blockIndex, 1);
                                    if (targetRow) targetRow.classList.remove('selected');

                                } else {
                                    // ì„ íƒ ì¶”ê°€
                                    if (targetRow) { 
                                        this.selectedDiffBlocks.push({ index: index.toString(), row: targetRow, panel: targetPanel });
                                        targetRow.classList.add('selected');
                                    }
                                }
                                this.lastSelectedIndex = index;
                                logger.info(`ë‹¤ì¤‘ ì„ íƒë¨: ${index} (${targetPanel})`);

                            // 3. ì¼ë°˜ í´ë¦­: ë‹¨ì¼ ì„ íƒ
                            } else {
                                // ëª¨ë“  ì„ íƒ í•´ì œ
                                document.querySelectorAll('.line-row.selected').forEach(r => r.classList.remove('selected'));
                                
                                // ì„ íƒ ì´ˆê¸°í™” í›„ í˜„ì¬ ì¤„ë§Œ ì¶”ê°€
                                this.selectedDiffBlocks = [{ index: index.toString(), row, panel }];
                                
                                row.classList.add('selected'); // í˜„ì¬ í´ë¦­ëœ ì¤„ë§Œ í•˜ì´ë¼ì´íŠ¸
                                
                                this.lastSelectedIndex = index;
                                this.lastFocusedPanel = clickedPanel; // ë‹¨ì¼ í´ë¦­ ì‹œ ê¸°ì¤€ íŒ¨ë„ ì—…ë°ì´íŠ¸
                                logger.info(`ë‹¨ì¼ ì„ íƒë¨: ${index} (${clickedPanel})`);
                            }
                        });
                    }
                });
            }
            
            // â˜… [ìˆ˜ì •] ì„ íƒëœ ì¤„ ì‚­ì œ ê¸°ëŠ¥ (deleteSelectedBtn -> deleteBtn ID ë³€ê²½ ë°˜ì˜)
            deleteSelectedLines() {
                if (this.selectedDiffBlocks.length === 0) {
                    this.updateStatus('ì‚­ì œí•  ì¤„ì„ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }
                
                // ì‚­ì œëŠ” ì˜¤ë¥¸ìª½ íŒŒì¼ì—ì„œë§Œ ê°€ëŠ¥í•˜ë©°, ì˜¤ë¥¸ìª½ ì¤„ ë²ˆí˜¸ê°€ ìˆëŠ” ë¸”ë¡ë§Œ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤.
                const rightLines = this.rightContent.split('\n');
                const indicesToRemove = new Set();
                
                // 1. ì„ íƒëœ ë¸”ë¡ì˜ ì‹¤ì œ ì˜¤ë¥¸ìª½ ë¼ì¸ ë²ˆí˜¸ë¥¼ ìˆ˜ì§‘
                this.selectedDiffBlocks.forEach(block => {
                    const rightRowElement = document.querySelector(`#rightEditor .line-row[data-index="${block.index}"]`);
                    const lineNumEl = rightRowElement ? rightRowElement.querySelector('.line-number') : null;
                    
                    if (lineNumEl && lineNumEl.textContent && rightRowElement.dataset.type !== 'empty') {
                        // ìœ íš¨í•œ ì¤„ ë²ˆí˜¸ê°€ ìˆê³ , ë¹ˆ ì¤„ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì‚­ì œ ëª©ë¡ì— ì¶”ê°€
                        const rightLineNum = parseInt(lineNumEl.textContent);
                        indicesToRemove.add(rightLineNum - 1); // 0-based index
                    }
                });
                
                if (indicesToRemove.size === 0) {
                     this.updateStatus('ì„ íƒëœ ì¤„ ì¤‘ì—ì„œ ì˜¤ë¥¸ìª½ íŒŒì¼ì— ì¡´ì¬í•˜ëŠ” ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.');
                     return;
                }

                this.saveToUndoStack(); // ì‚­ì œ ì „ ìƒíƒœ ì €ì¥

                // 2. ì‚­ì œí•  ì¸ë±ìŠ¤ë¥¼ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ (ì¸ë±ìŠ¤ ë³€ê²½ ë°©ì§€)
                const sortedIndices = Array.from(indicesToRemove).sort((a, b) => b - a);

                // 3. ì˜¤ë¥¸ìª½ íŒŒì¼ì—ì„œ í•´ë‹¹ ì¤„ ì‚­ì œ
                sortedIndices.forEach(index => {
                    if (index >= 0 && index < rightLines.length) {
                        rightLines.splice(index, 1);
                    }
                });

                this.rightContent = rightLines.join('\n');
                
                // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                this.selectedDiffBlocks = [];
                document.querySelectorAll('.line-row.selected').forEach(r => r.classList.remove('selected'));
                
                // í™”ë©´ ê°±ì‹ 
                this.compare(); 
                this.updateUndoRedoButtons();
                this.updateStatus(`${sortedIndices.length}ê°œì˜ ì¤„ì´ ìš°ì¸¡ íŒŒì¼ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // â˜… [ìˆ˜ì •] ì‚­ì œ í›„ ì¦‰ì‹œ ë°±ì—… ì²´í¬ í˜¸ì¶œ ì œê±°. ìë™ ì €ì¥ ë£¨í‹´ì— ë§¡ê¹€.
                // this.checkAndBackupFile();
            }


            saveToUndoStack() {
                if (this.rightContent) {
                    // Undo ìŠ¤íƒ ë¡œì§: ë¬´ì¡°ê±´ ì €ì¥í•˜ì—¬ ë³€ê²½ ì‚¬í•­ì„ ê¸°ë¡í•©ë‹ˆë‹¤.
                    this.undoStack.push(this.rightContent);
                    if (this.undoStack.length > this.maxUndoStack) {
                        this.undoStack.shift();
                    }
                    this.redoStack = [];
                    this.updateUndoRedoButtons();
                    logger.info(`Undo ìŠ¤íƒì— ì €ì¥ (ìŠ¤íƒ í¬ê¸°: ${this.undoStack.length})`);
                }
            }

			undo() {
                // Undo ìŠ¤íƒì— 1ê°œ ì´ìƒì˜ í•­ëª©ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. (ìµœì†Œí•œ ì›ë³¸ì€ ìˆì–´ì•¼ í•¨)
				if (this.undoStack.length > 1) {
                    // í˜„ì¬ ìƒíƒœë¥¼ popí•˜ì—¬ redoStackì— í‘¸ì‹œ
					const cur = this.undoStack.pop();
					this.redoStack.push(cur);
                    
                    // ì´ì „ ìƒíƒœë¡œ rightContent ë³µêµ¬ (ìŠ¤íƒì˜ ë§¨ ë§ˆì§€ë§‰ í•­ëª©)
					this.rightContent = this.undoStack[this.undoStack.length - 1];
                    
					this.compare(); 

					this.updateUndoRedoButtons(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
					logger.info(`Undo ì‹¤í–‰ë¨ (ìŠ¤íƒ í¬ê¸°: ${this.undoStack.length})`);
				} else if (this.undoStack.length === 1) {
                    // Undo ìŠ¤íƒì— ì›ë³¸ í•˜ë‚˜ë§Œ ë‚¨ì•˜ì„ ê²½ìš° 
                    const cur = this.undoStack.pop();
                    this.redoStack.push(cur);
                    
                    this.compare();
                    this.updateUndoRedoButtons();
                    logger.info(`Undo ì‹¤í–‰ë¨ (ìµœì´ˆ ìƒíƒœ). ë” ì´ìƒ ë˜ëŒë¦´ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.`);

                } else {
                    // ìŠ¤íƒì´ ì™„ì „íˆ ë¹„ì—ˆì„ ë•Œ (length === 0)
                    logger.warn('Undo ìŠ¤íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤. ì‹¤í–‰ ì·¨ì†Œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // Undo í›„ ì¦‰ì‹œ ë°±ì—… ì²´í¬ í˜¸ì¶œ ì œê±°. ìë™ ì €ì¥ ë£¨í‹´ì— ë§¡ê¹€.
                // this.checkAndBackupFile();
			}

			redo() {
				if (this.redoStack.length > 0) {
					const content = this.redoStack.pop();
					this.undoStack.push(content);
					this.rightContent = content;
					this.compare(); // renderRightEditor ëŒ€ì‹  compare í˜¸ì¶œ

					this.updateUndoRedoButtons(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
					logger.info(`Redo ì‹¤í–‰ë¨ (Redo ìŠ¤íƒ í¬ê¸°: ${this.redoStack.length})`);
				}
                
                // Redo í›„ ì¦‰ì‹œ ë°±ì—… ì²´í¬ í˜¸ì¶œ ì œê±°. ìë™ ì €ì¥ ë£¨í‹´ì— ë§¡ê¹€.
                // this.checkAndBackupFile();
			}


            updateUndoRedoButtons() {
                // UndoëŠ” ìŠ¤íƒì— ì›ë³¸ì„ í¬í•¨í•˜ì—¬ 1ê°œ ì´ìƒ í•­ëª©ì´ ìˆì„ ë•Œ í™œì„±í™”
                document.getElementById('undoBtn').disabled = this.undoStack.length === 0;
                document.getElementById('redoBtn').disabled = this.redoStack.length === 0;
            }

			copyToRight() {
                // ì„ íƒëœ ë¸”ë¡ì´ ì—†ìœ¼ë©´ ì•Œë¦¼
                if (this.selectedDiffBlocks.length === 0) {
                    alert('ë³µì‚¬í•  ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”.\nì™¼ìª½ íŒ¨ë„ì—ì„œ ì¤„ ë²ˆí˜¸ë¥¼ í´ë¦­(Ctrl, Shift)í•˜ì—¬ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì„ íƒëœ ë¸”ë¡ ì¤‘ ì™¼ìª½ íŒŒì¼ì— í•´ë‹¹í•˜ëŠ” ë¸”ë¡ë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
                const leftBlocks = this.selectedDiffBlocks.filter(b => b.panel === 'left');
                
                if (leftBlocks.length === 0) {
                    this.updateStatus('ë³µì‚¬í•  ë‚´ìš©ì€ ì™¼ìª½ íŒŒì¼ì—ì„œ ì„ íƒë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                const leftLines = this.leftContent.split('\n');
                const rightLines = this.rightContent.split('\n');

                logger.info(`=== ì¼ê´„ ë³µì‚¬ ì‹œì‘ ===`);
                logger.info(`ì„ íƒëœ ë¸”ë¡ ìˆ˜: ${leftBlocks.length}`);

                // 1. ì„ íƒëœ ë¸”ë¡ë“¤ì˜ 'ì‹¤ì œ ì™¼ìª½ ë¼ì¸ ì¸ë±ìŠ¤'ë¥¼ ìˆ˜ì§‘
                const selectedLeftIndices = new Set();
                
                leftBlocks.forEach(block => {
                    const row = document.querySelector(`#leftEditor .line-row[data-index="${block.index}"]`);
                    if (row) {
                        const lineNumText = row.querySelector('.line-number').textContent;
                        if (lineNumText) {
                            const leftLineNum = parseInt(lineNumText);
                            const leftArrayIndex = leftLineNum - 1; // 0-based index ë³€í™˜
                            selectedLeftIndices.add(leftArrayIndex);
                        }
                    }
                });

                // 2. Diff ì¬ê³„ì‚° (ì •í™•í•œ ìœ„ì¹˜ ë³‘í•©ì„ ìœ„í•´)
                const differ = new MyersDiff(leftLines, rightLines);
                const diffResult = differ.compute();

                const newRightLines = [];

                // 3. Diff ê²°ê³¼ë¥¼ ìˆœíšŒí•˜ë©° ìƒˆ ì˜¤ë¥¸ìª½ íŒŒì¼ ë‚´ìš© ìƒì„±
                for (let i = 0; i < diffResult.length; i++) {
                    const item = diffResult[i];
                    
                    if (item.type === 'equal') {
                        // ë™ì¼í•œ ë¼ì¸ì€ ì˜¤ë¥¸ìª½ ë‚´ìš© ìœ ì§€
                        newRightLines.push(rightLines[item.rightIdx]);
                        
                    } else if (item.type === 'removed') {
                        // ì™¼ìª½ì—ë§Œ ìˆëŠ” ë¼ì¸ (ë¹¨ê°„ìƒ‰)
                        const leftIdx = item.leftIdx;
                        
                        if (selectedLeftIndices.has(leftIdx)) {
                            // ì‚¬ìš©ìê°€ ì„ íƒí•œ ë²”ìœ„ì— í¬í•¨ë¨ -> ì˜¤ë¥¸ìª½ì— ì¶”ê°€(ë³µì‚¬)
                            newRightLines.push(leftLines[leftIdx]);
                            logger.info(`ë¼ì¸ ë³µì‚¬ë¨: ${leftLines[leftIdx]}`);
                        } else {
                            // ì„ íƒë˜ì§€ ì•ŠìŒ -> ê±´ë„ˆëœ€
                        }
                        
                    } else if (item.type === 'added') {
                        // ì˜¤ë¥¸ìª½ì—ë§Œ ìˆëŠ” ë¼ì¸ (ì´ˆë¡ìƒ‰) -> ìœ ì§€
                        newRightLines.push(rightLines[item.rightIdx]);
                    }
                }
                
                // 4. ë³€ê²½ ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                const oldContent = this.rightContent;
                this.rightContent = newRightLines.join('\n');
                
                if (oldContent !== this.rightContent) {
                    // 5. ê²°ê³¼ ì ìš© ë° Undo ìŠ¤íƒ ì €ì¥
                    this.saveToUndoStack(); // ë‚´ìš© ë³€ê²½ í›„ ì €ì¥
                }

                
                // ìš°ì¸¡ íŒŒì¼ í¸ì§‘ ê°€ëŠ¥ ìƒíƒœë¡œ ë³€ê²½
                this.isRightEditable = true;
                
                logger.info(`=== ë³µì‚¬ ì™„ë£Œ ===`);
                
                // ì„ íƒ ì´ˆê¸°í™” ë° í™”ë©´ ê°±ì‹ 
                this.selectedDiffBlocks = [];
                document.querySelectorAll('.line-row.selected').forEach(r => r.classList.remove('selected'));
                
                this.compare();
                this.updateUndoRedoButtons(); // Undo ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                this.updateStatus(`${selectedLeftIndices.size}ê°œ ë¼ì¸ì„ ìš°ì¸¡ìœ¼ë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤ (ìš°ì¸¡ íŒŒì¼ í¸ì§‘ ê°€ëŠ¥)`);
                
                // â˜… [ìˆ˜ì •] ë³µì‚¬ í›„ ì¦‰ì‹œ ë°±ì—… ì²´í¬ í˜¸ì¶œ ì œê±°. ìë™ ì €ì¥ ë£¨í‹´ì— ë§¡ê¹€.
                // this.checkAndBackupFile();
            }         

            // ì°¾ê¸°/ë°”ê¾¸ê¸° ëŒ€í™” ìƒì ìœ„ì¹˜ ì¡°ì •
            moveDialogToOppositePanel(dialogElement) {
                if (this.searchPanel === 'left') {
                    // ì™¼ìª½ì—ì„œ ì°¾ì„ ë•ŒëŠ” ë°•ìŠ¤ë¥¼ ì˜¤ë¥¸ìª½ (í™”ë©´ ì˜¤ë¥¸ìª½ 50% ì§€ì )ìœ¼ë¡œ ì´ë™
                    dialogElement.style.left = 'calc(50% + 50px)';
                } else {
                    // ì˜¤ë¥¸ìª½ì—ì„œ ì°¾ì„ ë•ŒëŠ” ë°•ìŠ¤ë¥¼ ì™¼ìª½ (í™”ë©´ ì™¼ìª½ 50% ì§€ì )ìœ¼ë¡œ ì´ë™
                    dialogElement.style.left = '15%'; 
                }
            }
            
            // ê²€ìƒ‰ íŒ¨ë„ ì„¤ì • í•¨ìˆ˜ 
            setSearchPanel(panel, dialogType) {
                this.searchPanel = panel;
                
                let targetId;
                let dialogElement;
                
                if (dialogType === 'find') {
                    targetId = 'findTarget';
                    dialogElement = document.getElementById('findDialog');
                } else {
                    return; // ë°”ê¾¸ê¸° ê¸°ëŠ¥ ì œê±°
                }
                
                // íƒ€ê²Ÿ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                const targetText = (this.searchPanel === 'left' ? 'ì™¼ìª½ íŒŒì¼ì—ì„œ ê²€ìƒ‰' : 'ì˜¤ë¥¸ìª½ íŒŒì¼ì—ì„œ ê²€ìƒ‰');
                    
                document.getElementById(targetId).textContent = `ğŸ“ ${targetText}`;
                
                // ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì¡°ì •
                this.moveDialogToOppositePanel(dialogElement);
                
                logger.info(`ê²€ìƒ‰ íŒ¨ë„ ì„¤ì •: ${panel}`);
            }
            
            // ì°¾ê¸° ê¸°ëŠ¥
            openFindDialog(targetPanel) {
                // targetPanelì„ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
                this.searchPanel = targetPanel;
                
                const selectedText = this.getSelectedText();
                if (selectedText) {
                    document.getElementById('findInput').value = selectedText;
                }
                
                // ê²€ìƒ‰ íŒ¨ë„ ë²„íŠ¼ ìƒíƒœ ì„¤ì • ë° ìœ„ì¹˜ ì¡°ì •
                this.setSearchPanel(this.searchPanel, 'find');
                
                document.getElementById('findDialog').classList.add('active');
                document.getElementById('findOverlay').classList.add('active');
                document.getElementById('findInput').focus();
                document.getElementById('findInput').select();
                
                // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ ê²€ìƒ‰
                this.performSearch(document.getElementById('findInput').value, 
                                  document.getElementById('findCaseSensitive').checked, 
                                  document.getElementById('findWholeWord').checked);
            }

            closeFindDialog() {
                document.getElementById('findDialog').classList.remove('active');
                document.getElementById('findOverlay').classList.remove('active');
                this.clearHighlights();
            }

			playBeep() {
                try {
                    // Web Audio APIë¥¼ ì‚¬ìš©í•˜ì—¬ í†¤ ìƒì„±
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = context.createOscillator();
                    const gain = context.createGain();

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, context.currentTime); // 440 Hz (A4)
                    gain.gain.setValueAtTime(0.5, context.currentTime);

                    oscillator.connect(gain);
                    gain.connect(context.destination);

                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.1); // 100ms ì¬ìƒ

                    // ë¶€ë“œëŸ½ê²Œ ì†Œë¦¬ ì†Œë©¸ (í´ë¦­ ì†Œë¦¬ ë°©ì§€)
                    gain.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.1);
                } catch (e) {
                    // ë¸Œë¼ìš°ì € ì§€ì›í•˜ì§€ ì•Šì„ ê²½ìš° ë¡œê·¸ë§Œ ë‚¨ê¹€
                    logger.warn("Web Audio API ì˜¤ë¥˜ë¡œ ê²½ê³ ìŒ ì¬ìƒ ì‹¤íŒ¨.");
                }
            }
			
findNext() {
                const searchText = document.getElementById('findInput').value;
                const caseSensitive = document.getElementById('findCaseSensitive').checked;
                const wholeWord = document.getElementById('findWholeWord').checked;
                
                if (!searchText) return;

                this.performSearch(searchText, caseSensitive, wholeWord);
                
                if (this.searchResults.length === 0) {
                    this.updateStatus('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
                    return;
                }

                const nextIndex = this.currentSearchIndex + 1;

                if (nextIndex >= this.searchResults.length) {
                    this.playBeep(); // â˜… ê²½ê³ ìŒë§Œ ì¬ìƒ
                    this.updateStatus('ê²€ìƒ‰ ê²°ê³¼ì˜ ëì…ë‹ˆë‹¤.');
                    return; // â˜… ë¡¤ì˜¤ë²„ ë°©ì§€
                }

                this.currentSearchIndex = nextIndex;
                this.highlightSearchResult(this.currentSearchIndex);
                this.updateStatus(`${this.currentSearchIndex + 1} / ${this.searchResults.length}`);
            }

            findPrev() {
                const searchText = document.getElementById('findInput').value;
                const caseSensitive = document.getElementById('findCaseSensitive').checked;
                const wholeWord = document.getElementById('findWholeWord').checked;
                
                if (!searchText) return;

                this.performSearch(searchText, caseSensitive, wholeWord);
                
                if (this.searchResults.length === 0) {
                    this.updateStatus('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
                    return;
                }

                const prevIndex = this.currentSearchIndex - 1;

                if (prevIndex < 0) {
                    this.playBeep(); // â˜… ê²½ê³ ìŒë§Œ ì¬ìƒ
                    this.updateStatus('ê²€ìƒ‰ ê²°ê³¼ì˜ ì²˜ìŒì…ë‹ˆë‹¤.');
                    return; // â˜… ë¡¤ì˜¤ë²„ ë°©ì§€
                }

                this.currentSearchIndex = prevIndex;
                this.highlightSearchResult(this.currentSearchIndex);
                this.updateStatus(`${this.currentSearchIndex + 1} / ${this.searchResults.length}`);
            }

            performSearch(searchText, caseSensitive, wholeWord) {
                // ê²€ìƒ‰ì–´ ë³€ê²½ ì‹œì—ë§Œ ì´ˆê¸°í™”
                const currentSearchPanel = this.searchPanel;
                const currentSearchText = searchText;
                
                if (this._lastSearchText !== currentSearchText || this._lastSearchPanel !== currentSearchPanel) {
                    this.clearHighlights();
                    this.searchResults = [];
                    this.currentSearchIndex = -1;
                    
                    const editorId = currentSearchPanel === 'left' ? 'leftEditor' : 'rightEditor';
                    const editor = document.getElementById(editorId);
                    const lines = editor.querySelectorAll('.line-content');

                    let flags = 'g';
                    if (!caseSensitive) flags += 'i';

                    let pattern = this.escapeRegex(currentSearchText);
                    if (wholeWord) {
                        pattern = `\\b${pattern}\\b`;
                    }

                    const regex = new RegExp(pattern, flags);

                    lines.forEach((line) => {
                        const text = line.textContent;
                        const matches = text.matchAll(regex);
                        
                        for (const match of matches) {
                            this.searchResults.push({
                                line,
                                text,
                                matchIndex: match.index,
                                matchLength: match[0].length
                            });
                        }
                    });

                    this._lastSearchText = currentSearchText;
                    this._lastSearchPanel = currentSearchPanel;
                    
                    logger.info(`ê²€ìƒ‰ ê²°ê³¼: ${this.searchResults.length}ê°œ ë°œê²¬`);
                }
            }

            highlightSearchResult(index) {
                this.clearHighlights();
                
                if (index < 0 || index >= this.searchResults.length) return;

                const result = this.searchResults[index];
                const line = result.line;
                const text = result.text;
                const matchIndex = result.matchIndex;
                const matchLength = result.matchLength;

                // ì¬êµ¬ì„±ì„ ìœ„í•´ í…ìŠ¤íŠ¸ì—ì„œ HTML ì—”í‹°í‹°ë¥¼ ì„ì‹œë¡œ ì œê±°í•©ë‹ˆë‹¤.
                const unescapedText = this.unescapeHtml(text);
                const before = this.escapeHtml(unescapedText.substring(0, matchIndex));
                const match = this.escapeHtml(unescapedText.substring(matchIndex, matchIndex + matchLength));
                const after = this.escapeHtml(unescapedText.substring(matchIndex + matchLength));

                // í˜„ì¬ í•˜ì´ë¼ì´íŠ¸ ì ìš©
                line.innerHTML = `${before}<span class="search-highlight current">${match}</span>${after}`;
                
                // ë‹¤ë¥¸ ì¼ì¹˜ í•­ëª© í•˜ì´ë¼ì´íŠ¸ (ê°™ì€ ë¼ì¸ ë° ë‹¤ë¥¸ ë¼ì¸)
                this.searchResults.forEach((r, i) => {
                    if (i !== index) {
                        // ë‹¤ë¥¸ ë¼ì¸ì˜ í•˜ì´ë¼ì´íŠ¸ (ì¼ë°˜ í•˜ì´ë¼ì´íŠ¸)
                        const r_unescapedText = this.unescapeHtml(r.text);
                        const b = this.escapeHtml(r_unescapedText.substring(0, r.matchIndex));
                        const m = this.escapeHtml(r_unescapedText.substring(r.matchIndex, r.matchIndex + r.matchLength));
                        const a = this.escapeHtml(r_unescapedText.substring(r.matchIndex + r.matchLength));
                        r.line.innerHTML = `${b}<span class="search-highlight">${m}</span>${a}`;
                    }
                });

                line.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            clearHighlights() {
                // searchPanelì´ 'find' ëª¨ë“œì—ì„œ ì„¤ì •ë˜ì—ˆì„ ê²ƒì´ë¯€ë¡œ ë°”ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const editorId = this.searchPanel === 'left' ? 'leftEditor' : 'rightEditor';
                const editor = document.getElementById(editorId);
                
                // ëª¨ë“  ë¼ì¸ ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const lines = editor.querySelectorAll('.line-content');
                
                lines.forEach(line => {
                    // HTML ë‚´ìš©ì„ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ ë‚´ìš©ìœ¼ë¡œë§Œ ëŒ€ì²´í•©ë‹ˆë‹¤.
                    const textContent = line.textContent;
                    // contentEditableì´ë“  ì•„ë‹ˆë“ , HTML ì—”í‹°í‹°ë¥¼ ë³µêµ¬í•˜ì—¬ ë„£ìŠµë‹ˆë‹¤.
                    line.innerHTML = this.escapeHtml(textContent);
                });
            }

            escapeRegex(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // --- ë°±ì—… íŒŒì¼ ìƒì„± í•¨ìˆ˜ (ìˆ˜ì •ë¨) ---
            backupFile() {
                if (!this.rightContent || !this.rightFileName) {
                    logger.warn('ë°±ì—…í•  íŒŒì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // â˜… [ìˆ˜ì •] ë°±ì—… ì„±ê³µ ì‹œ lastSavedContent ê°±ì‹ 
                this.lastSavedContent = this.rightContent; 
                
                const originalFileName = this.rightFileName;
                const lastDotIndex = originalFileName.lastIndexOf('.');
                
                // íŒŒì¼ ì´ë¦„ê³¼ í™•ì¥ì ë¶„ë¦¬ (í™•ì¥ìê°€ ì—†ëŠ” ê²½ìš°ë„ ì²˜ë¦¬)
                let namePart = lastDotIndex === -1 ? originalFileName : originalFileName.substring(0, lastDotIndex);
                let extPart = lastDotIndex === -1 ? '' : originalFileName.substring(lastDotIndex);
                
                // ê¸°ì¡´ ì´ë¦„ì—ì„œ (ìˆ«ì) ë¶€ë¶„ì„ ì œê±°
                const cleanNameMatch = namePart.match(/^(.*?)(?:\(\d+\))?$/);
                const baseName = cleanNameMatch ? cleanNameMatch[1].trim() : namePart.trim();
                
                // â˜… [ìˆ˜ì •] íƒ€ì„ìŠ¤íƒ¬í”„ íƒœê·¸ ìƒì„±
                const now = new Date();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                const timestampTag = `_${month}${day}_${hour}${minute}`;
                
                // ë°±ì—… íŒŒì¼ ì´ë¦„ ìƒì„± (baseName_MMDD_HHMM.ext)
                const backupName = `${baseName}${timestampTag}${extPart}`;
                
                // ë¸Œë¼ìš°ì €ì— ë‹¤ìš´ë¡œë“œ ìš”ì²­
                const success = this._triggerDownload(this.rightContent, backupName, false);
                
                if (success) {
                    logger.info(`ìë™ ë°±ì—… íŒŒì¼ ìƒì„±ë¨: ${backupName}`);
                } else {
                    logger.error("ìë™ ë°±ì—… íŒŒì¼ ìƒì„± ìš”ì²­ ì‹¤íŒ¨. ë‹¤ìš´ë¡œë“œ ê²½ê³ ì°½ì„ í™•ì¸í•˜ì„¸ìš”.");
                }
            }
            // ------------------------------------

            // --- íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ ë¡œì§ (ê³µí†µ) ---
            _triggerDownload(content, filename, isOverwrite) {
                try {
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    return true;
                } catch (e) {
                    logger.error(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (${filename}): ${e.message}`);
                    return false;
                }
            }
            // ------------------------------------


            // --- saveFile í•¨ìˆ˜ ìˆ˜ì •: ë¬»ì§€ ì•Šê³  ë®ì–´ì“°ê¸° ì €ì¥ ---
            saveFile() {
                if (!this.rightContent || !this.rightFileName) {
                    alert('ì €ì¥í•  ë‚´ìš©ì´ë‚˜ íŒŒì¼ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // â˜… [ìˆ˜ì •] ë‚´ìš© ë³€ê²½ ì—¬ë¶€ í™•ì¸: ìˆ˜ì • ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
                if (this.rightContent === this.lastSavedContent) {
                    this.updateStatus('ìˆ˜ì •ëœ ë‚´ìš©ì´ ì—†ìœ¼ë¯€ë¡œ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // â˜… [ìˆ˜ì •] ë‚´ìš©ì´ ìˆ˜ì •ë˜ì—ˆì„ ê²½ìš° lastSavedContent ê°±ì‹ 
                this.lastSavedContent = this.rightContent; 
                
                // í˜„ì¬ íŒŒì¼ì„ ë¬»ì§€ ì•Šê³  ë°”ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
                const downloadName = this.rightFileName || 'edited_file.txt';
                this._triggerDownload(this.rightContent, downloadName, true);

                logger.info(`íŒŒì¼ ì €ì¥ë¨ (ë®ì–´ì“°ê¸°): ${downloadName}`);
                this.updateStatus(`íŒŒì¼ ì €ì¥ë¨: ${downloadName}`);
            }
            // -------------------------------------------------

            syncScroll() {
                const leftEditor = document.getElementById('leftEditor');
                const rightEditor = document.getElementById('rightEditor');

                let isSyncing = false;

                leftEditor.addEventListener('scroll', () => {
                    if (!isSyncing) {
                        isSyncing = true;
                        rightEditor.scrollTop = leftEditor.scrollTop;
                        setTimeout(() => isSyncing = false, 10);
                    }
                });

                rightEditor.addEventListener('scroll', () => {
                    if (!isSyncing) {
                        isSyncing = true;
                        leftEditor.scrollTop = rightEditor.scrollTop;
                        setTimeout(() => isSyncing = false, 10);
                    }
                });
            }

            calculateStats(diffResult) {
                const stats = {
                    added: 0,
                    removed: 0,
                    equal: 0
                };

                diffResult.forEach(item => {
                    if (item.type === 'added') stats.added++;
                    else if (item.type === 'removed') stats.removed++;
                    else if (item.type === 'equal') stats.equal++;
                });

                return stats;
            }

            // â˜… [ì‚­ì œ] updateDiffStats í•¨ìˆ˜ ì œê±°

            // â˜… [ìˆ˜ì •] updateStatus í•¨ìˆ˜: status-bar ì œê±°ë¡œ ë¡œê·¸ë§Œ ì¶œë ¥
            updateStatus(message) {
                // document.getElementById('statusText').textContent = message; // ì œê±°ë¨
                logger.info(`ìƒíƒœ ì—…ë°ì´íŠ¸: ${message}`);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                let html = div.innerHTML;
                
                // ê³µë°±ê³¼ íƒ­ì„ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜í•˜ì—¬ ë³´ì¡´
                html = html.replace(/ /g, '&nbsp;');
                html = html.replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
                
                return html;
            }
            
            unescapeHtml(html) {
                const div = document.createElement('div');
                // ê³µë°± ì—”í‹°í‹°ë¥¼ ì¼ë°˜ ê³µë°±ìœ¼ë¡œ ë¨¼ì € ë˜ëŒë¦½ë‹ˆë‹¤.
                html = html.replace(/&nbsp;/g, ' ');
                // íƒ­ ì—”í‹°í‹°ë¥¼ ì¼ë°˜ íƒ­ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤. (ì—¬ê¸°ì„œëŠ” ê³µë°± 4ê°œë¡œ ì²˜ë¦¬)
                html = html.replace(/ {4}/g, '\t'); 
                
                div.innerHTML = html;
                return div.textContent;
            }
        }

        const app = new UltraCompare();
    </script>
</body>
</html>